import React, { useState, useEffect, useMemo } from 'react';
import { 
  Search, 
  Tv, 
  Camera, 
  Headphones, 
  Gamepad2, 
  Sparkles, 
  BookOpen, 
  Award, 
  ChevronRight, 
  X,
  Menu,
  Home,
  MessageSquare,
  Zap,
  Info
} from 'lucide-react';

const SONY_CATEGORIES = [
  { id: 'tv', name: 'TV & Soundbar', icon: <Tv size={24} />, color: 'bg-zinc-900', products: 24 },
  { id: 'di', name: 'Digital Imaging', icon: <Camera size={24} />, color: 'bg-zinc-800', products: 42 },
  { id: 'audio', name: 'Audio & Gear', icon: <Headphones size={24} />, color: 'bg-zinc-700', products: 30 },
  { id: 'ps5', name: 'PlayStation 5', icon: <Gamepad2 size={24} />, color: 'bg-zinc-950', products: 12 },
];

const App = () => {
  const [activeTab, setActiveTab] = useState('home');
  const [searchQuery, setSearchQuery] = useState('');
  const [isAiOpen, setIsAiOpen] = useState(false);
  const [aiInput, setAiInput] = useState('');
  const [aiOutput, setAiOutput] = useState(null);
  const [isLoading, setIsLoading] = useState(false);

  const apiKey = ""; // S·∫Ω ƒë∆∞·ª£c h·ªá th·ªëng cung c·∫•p t·ª± ƒë·ªông

  // Fetch with Retry logic for Gemini API
  const fetchWithRetry = async (url, options, retries = 5, backoff = 1000) => {
    try {
      const res = await fetch(url, options);
      if (!res.ok) throw new Error(`HTTP Error: ${res.status}`);
      return res;
    } catch (err) {
      if (retries <= 0) throw err;
      await new Promise(resolve => setTimeout(resolve, backoff));
      return fetchWithRetry(url, options, retries - 1, backoff * 2);
    }
  };

  const generateAIContent = async (type) => {
    if (!aiInput) return;
    setIsLoading(true);
    setAiOutput(null);

    const systemPrompt = "B·∫°n l√† tr·ª£ l√Ω AI cao c·∫•p d√†nh cho Sony Trainer t·∫°i Vi·ªát Nam. H√£y g·ªçi ƒë·ªôi ng≈© PG/PB l√† 'Fan c·ª©ng Sony'. H√£y s·ª≠ d·ª•ng ng√¥n t·ª´ truy·ªÅn c·∫£m h·ª©ng, chuy√™n nghi·ªáp v√† ƒë·∫ßy t·ª± h√†o v·ªÅ c√¥ng ngh·ªá Sony.";
    
    let prompt = "";
    if (type === 'script') {
      prompt = `D·ª±a tr√™n s·∫£n ph·∫©m n√†y: "${aiInput}", h√£y so·∫°n k·ªãch b·∫£n Sales Talk truy·ªÅn c·∫£m h·ª©ng. Bao g·ªìm: 1. C√¢u h·ªèi ph√° bƒÉng. 2. 3 c√¥ng ngh·ªá ƒë·ªôc b·∫£n c·ªßa Sony. 3. C√¢u ch·ªët c·∫£m x√∫c.`;
    } else {
      prompt = `T·∫°o 3 c√¢u h·ªèi tr·∫Øc nghi·ªám c·ª±c kh√≥ v·ªÅ s·∫£n ph·∫©m n√†y: "${aiInput}" ƒë·ªÉ th·ª≠ th√°ch tr√¨nh ƒë·ªô 'Fan c·ª©ng Sony'. C√≥ ƒë√°p √°n v√† gi·∫£i th√≠ch k·ªπ thu·∫≠t s√¢u.`;
    }

    try {
      const response = await fetchWithRetry(
        `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,
        {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contents: [{ parts: [{ text: prompt }] }],
            systemInstruction: { parts: [{ text: systemPrompt }] }
          })
        }
      );

      const data = await response.json();
      const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
      setAiOutput(text);
    } catch (error) {
      setAiOutput("ƒê√£ c√≥ l·ªói x·∫£y ra khi k·∫øt n·ªëi v·ªõi b·ªô n√£o Sony AI. Vui l√≤ng th·ª≠ l·∫°i sau.");
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <div className="min-h-screen bg-neutral-50 text-neutral-900 pb-24 font-sans antialiased">
      {/* Top Header */}
      <header className="sticky top-0 z-40 bg-black text-white px-6 py-4 flex items-center justify-between border-b border-zinc-800">
        <div className="flex items-center gap-3">
          <span className="text-2xl font-black tracking-tighter italic">SONY</span>
          <div className="h-6 w-px bg-zinc-700 mx-1"></div>
          <span className="text-[10px] font-bold tracking-widest text-zinc-400 uppercase">Wiki Platform</span>
        </div>
        <div className="flex items-center gap-4">
          <div className="hidden md:flex flex-col items-end">
            <span className="text-[10px] text-green-500 font-bold uppercase tracking-tighter flex items-center gap-1">
              <span className="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse"></span> AI Service Online
            </span>
          </div>
          <button className="p-2 bg-zinc-800 rounded-full">
            <Info size={18} className="text-zinc-300" />
          </button>
        </div>
      </header>

      {/* Main Content Area */}
      <main className="max-w-4xl mx-auto p-4 md:p-8">
        
        {/* Search Bar - Sony Style */}
        <div className="relative mb-8">
          <Search className="absolute left-4 top-1/2 -translate-y-1/2 text-neutral-400" size={20} />
          <input 
            type="text" 
            placeholder="T√¨m ki·∫øm Bravia 9, Alpha 7C II, k·ªπ thu·∫≠t sale..."
            className="w-full bg-white border-2 border-neutral-200 rounded-2xl py-4 pl-12 pr-4 shadow-sm focus:border-black focus:ring-0 transition-all text-sm outline-none"
            value={searchQuery}
            onChange={(e) => setSearchQuery(e.target.value)}
          />
        </div>

        {activeTab === 'home' && (
          <>
            {/* Quick Stats Grid */}
            <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-10">
              {[
                { label: 'H·ªçc vi√™n', val: '450', trend: '+12%', icon: <Award className="text-yellow-500" /> },
                { label: 'B·∫£n tin m·ªõi', val: '12', trend: 'H√¥m nay', icon: <Zap className="text-blue-500" /> },
                { label: 'Wiki Docs', val: '850', trend: 'Full-cat', icon: <BookOpen className="text-zinc-600" /> },
                { label: 'AI Scripts', val: '1.2k', trend: 'Hot', icon: <Sparkles className="text-purple-500" /> },
              ].map((stat, i) => (
                <div key={i} className="bg-white p-4 rounded-2xl border border-neutral-100 shadow-sm">
                  <div className="flex justify-between items-start mb-2">
                    {stat.icon}
                    <span className="text-[10px] font-bold text-green-600 bg-green-50 px-1.5 py-0.5 rounded">{stat.trend}</span>
                  </div>
                  <p className="text-2xl font-black">{stat.val}</p>
                  <p className="text-[10px] text-neutral-500 font-bold uppercase tracking-wider">{stat.label}</p>
                </div>
              ))}
            </div>

            {/* Category Hub */}
            <div className="mb-10">
              <h2 className="text-sm font-bold uppercase tracking-[0.2em] text-neutral-400 mb-6 flex items-center gap-2">
                <div className="w-8 h-[2px] bg-black"></div> Danh m·ª•c s·∫£n ph·∫©m
              </h2>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                {SONY_CATEGORIES.map((cat) => (
                  <button 
                    key={cat.id}
                    className="group relative overflow-hidden bg-white rounded-3xl p-6 flex items-center justify-between border border-neutral-100 shadow-sm hover:shadow-xl transition-all duration-300"
                  >
                    <div className="flex items-center gap-4 z-10">
                      <div className={`p-4 rounded-2xl ${cat.color} text-white shadow-lg group-hover:scale-110 transition-transform`}>
                        {cat.icon}
                      </div>
                      <div className="text-left">
                        <h3 className="font-black text-lg group-hover:translate-x-1 transition-transform">{cat.name}</h3>
                        <p className="text-xs text-neutral-500 font-medium">{cat.products} s·∫£n ph·∫©m ƒë√£ c·∫≠p nh·∫≠t</p>
                      </div>
                    </div>
                    <ChevronRight className="text-neutral-300 group-hover:text-black transition-colors" />
                    {/* Decorative Background */}
                    <div className="absolute right-[-10px] bottom-[-10px] opacity-[0.03] group-hover:opacity-[0.05] transition-opacity">
                      {React.cloneElement(cat.icon, { size: 120 })}
                    </div>
                  </button>
                ))}
              </div>
            </div>

            {/* AI Assistant Call-to-action */}
            <div className="bg-zinc-950 rounded-[2.5rem] p-8 text-white relative overflow-hidden mb-10 shadow-2xl">
              <div className="relative z-10 max-w-sm">
                <div className="bg-purple-600 text-[10px] font-bold w-fit px-2 py-1 rounded-full mb-4 animate-pulse uppercase tracking-widest">Powered by Gemini</div>
                <h3 className="text-2xl font-bold mb-3">Tr·ª£ l√Ω AI cho Fan C·ª©ng</h3>
                <p className="text-zinc-400 text-sm mb-6 leading-relaxed">D√°n th√¥ng s·ªë s·∫£n ph·∫©m v√†o ƒë√¢y, AI s·∫Ω so·∫°n k·ªãch b·∫£n t∆∞ v·∫•n ƒë·∫ßy ƒëam m√™ v√† t·∫°o Quiz th·ª≠ th√°ch trong 3 gi√¢y.</p>
                <button 
                  onClick={() => setIsAiOpen(true)}
                  className="bg-white text-black font-black px-8 py-3 rounded-full hover:bg-neutral-200 transition-colors flex items-center gap-2"
                >
                  <Sparkles size={18} /> TR·∫¢I NGHI·ªÜM NGAY
                </button>
              </div>
              <div className="absolute right-[-20px] top-[-20px] text-zinc-800/30">
                <Sparkles size={240} strokeWidth={1} />
              </div>
            </div>
          </>
        )}

        {/* Placeholder for other tabs */}
        {activeTab !== 'home' && (
          <div className="flex flex-col items-center justify-center py-20 text-neutral-400">
            <BookOpen size={48} className="mb-4 opacity-20" />
            <p className="font-medium italic">T√≠nh nƒÉng {activeTab} ƒëang ƒë∆∞·ª£c ƒë·ªìng b·ªô d·ªØ li·ªáu...</p>
          </div>
        )}
      </main>

      {/* AI Modal Overlay */}
      {isAiOpen && (
        <div className="fixed inset-0 z-50 flex flex-col bg-white">
          <header className="p-4 flex justify-between items-center border-b">
            <div className="flex items-center gap-2">
              <Sparkles className="text-purple-600" />
              <span className="font-bold">SONY AI Assistant</span>
            </div>
            <button onClick={() => setIsAiOpen(false)} className="p-2 hover:bg-neutral-100 rounded-full">
              <X />
            </button>
          </header>
          
          <div className="flex-1 overflow-y-auto p-6 flex flex-col">
            <label className="text-xs font-bold text-neutral-400 uppercase tracking-widest mb-2 px-1">Nh·∫≠p th√¥ng s·ªë s·∫£n ph·∫©m</label>
            <textarea 
              value={aiInput}
              onChange={(e) => setAiInput(e.target.value)}
              placeholder="V√≠ d·ª•: Bravia 9 85 inch, Mini LED, Processor XR..."
              className="w-full h-32 p-4 bg-neutral-50 border border-neutral-200 rounded-2xl text-sm focus:ring-0 focus:border-black resize-none mb-4"
            />
            
            <div className="flex gap-2 mb-8">
              <button 
                onClick={() => generateAIContent('script')}
                disabled={isLoading}
                className="flex-1 bg-black text-white font-bold py-4 rounded-2xl flex items-center justify-center gap-2 disabled:opacity-50"
              >
                {isLoading ? <span className="animate-spin">üåÄ</span> : <MessageSquare size={18} />}
                So·∫°n Sales Talk
              </button>
              <button 
                onClick={() => generateAIContent('quiz')}
                disabled={isLoading}
                className="flex-1 border-2 border-black font-bold py-4 rounded-2xl flex items-center justify-center gap-2 disabled:opacity-50"
              >
                {isLoading ? <span className="animate-spin">üåÄ</span> : <Zap size={18} />}
                T·∫°o Quiz
              </button>
            </div>

            {aiOutput && (
              <div className="bg-neutral-900 text-zinc-100 p-6 rounded-3xl leading-relaxed whitespace-pre-line text-sm border-t-4 border-purple-500">
                <div className="mb-4 flex items-center gap-2 text-purple-400 font-bold uppercase text-[10px] tracking-widest">
                  <Sparkles size={14} /> Ph·∫£n h·ªìi t·ª´ SONY AI
                </div>
                {aiOutput}
              </div>
            )}
            
            {isLoading && (
              <div className="flex flex-col items-center justify-center py-10">
                <div className="w-12 h-12 border-4 border-neutral-200 border-t-black rounded-full animate-spin"></div>
                <p className="mt-4 text-xs font-bold text-neutral-400 animate-pulse uppercase tracking-[0.2em]">ƒêang x·ª≠ l√Ω d·ªØ li·ªáu Sony...</p>
              </div>
            )}
          </div>
        </div>
      )}

      {/* Bottom Navigation - Mobile First */}
      <nav className="fixed bottom-0 left-0 right-0 bg-white/90 backdrop-blur-xl border-t border-neutral-100 flex justify-around items-center py-3 px-2 z-40 shadow-[0_-5px_20px_rgba(0,0,0,0.05)]">
        {[
          { id: 'home', label: 'Home', icon: <Home size={22} /> },
          { id: 'wiki', label: 'Wiki', icon: <BookOpen size={22} /> },
          { id: 'quiz', label: 'Quiz', icon: <Zap size={22} /> },
          { id: 'awards', label: 'Profile', icon: <Award size={22} /> },
        ].map((item) => (
          <button 
            key={item.id}
            onClick={() => setActiveTab(item.id)}
            className={`flex flex-col items-center gap-1 transition-all px-4 py-1 rounded-xl ${activeTab === item.id ? 'text-black' : 'text-neutral-400'}`}
          >
            <div className={`${activeTab === item.id ? 'scale-110' : ''} transition-transform`}>
              {item.icon}
            </div>
            <span className={`text-[10px] font-bold uppercase tracking-widest ${activeTab === item.id ? 'opacity-100' : 'opacity-0'}`}>
              {item.label}
            </span>
            {activeTab === item.id && <div className="w-1 h-1 bg-black rounded-full mt-1"></div>}
          </button>
        ))}
      </nav>
    </div>
  );
};

export default App;
